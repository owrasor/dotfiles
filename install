#!/usr/bin/env bash

DOTFILES=$(cd $(dirname "${BASH_SOURCE[0]}") && pwd)

# Function to install packages across different distributions
install_pkg() {
    local pkg=$1
    local cmd=${2:-$pkg}
    if command -v "$cmd" >/dev/null 2>&1; then
        echo "Checking for $cmd: installed"
        return 0
    fi

    echo "No $cmd. Setting up $pkg."
    if command -v apt-get >/dev/null 2>&1; then
        sudo apt-get update && sudo apt-get --yes install "$pkg"
    elif command -v dnf >/dev/null 2>&1; then
        sudo dnf install -y "$pkg"
    elif command -v pacman >/dev/null 2>&1; then
        sudo pacman -S --noconfirm "$pkg"
    elif command -v zypper >/dev/null 2>&1; then
        sudo zypper install -y "$pkg"
    else
        echo "Error: No supported package manager found. Please install $pkg manually."
        return 1
    fi
}

# Ensure dependencies are installed
install_pkg zsh
install_pkg curl
install_pkg git
install_pkg tmux
install_pkg jq
install_pkg ruby
install_pkg rustc

# Neovim and dependencies
install_pkg neovim nvim
install_pkg ripgrep rg
install_pkg unzip
if command -v apt-get >/dev/null 2>&1; then
    install_pkg build-essential make
    install_pkg fd-find fdfind
elif command -v pacman >/dev/null 2>&1; then
    install_pkg base-devel make
    install_pkg fd
else
    install_pkg gcc
    install_pkg make
    install_pkg fd
fi

# Lazygit installation
if ! command -v lazygit >/dev/null 2>&1; then
    echo "Installing Lazygit..."
    LAZYGIT_VERSION=$(curl -s "https://api.github.com/repos/jesseduffield/lazygit/releases/latest" | grep -Po '"tag_name": "v\K[^"]*')
    curl -Lo lazygit.tar.gz "https://github.com/jesseduffield/lazygit/releases/latest/download/lazygit_${LAZYGIT_VERSION}_Linux_x86_64.tar.gz"
    tar xf lazygit.tar.gz lazygit
    sudo install lazygit /usr/local/bin
    rm lazygit lazygit.tar.gz
else
    echo "Checking for lazygit: installed"
fi

# Lazydocker installation
if ! command -v lazydocker >/dev/null 2>&1; then
    echo "Installing Lazydocker..."
    curl https://raw.githubusercontent.com/jesseduffield/lazydocker/master/scripts/install_update_linux.sh | bash
    # Lazydocker script installs to ~/.local/bin by default if not specified
else
    echo "Checking for lazydocker: installed"
fi

# Tmuxinator installation
if ! command -v tmuxinator >/dev/null 2>&1; then
    echo "Installing Tmuxinator..."
    sudo gem install tmuxinator
else
    echo "Checking for tmuxinator: installed"
fi

# Oh My Zsh installation
DIR="$HOME/.oh-my-zsh"
if [ ! -d "$DIR" ]; then
    echo "No oh-my-zsh. Setting up oh-my-zsh"
    sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended
else
    echo "Checking for oh-my-zsh: installed"
fi

# Zsh-artisan plugin
DIR="$HOME/.oh-my-zsh/custom/plugins/artisan"
if [ ! -d "$DIR" ]; then
    echo "No zsh-artisan plugin. Setting up zsh-artisan"
    git clone https://github.com/owrasor/zsh-artisan.git "$DIR"
else
    echo "Checking for zsh-artisan plugin: installed"
fi

# Powerlevel10k theme
DIR="$HOME/.oh-my-zsh/custom/themes/powerlevel10k"
if [ ! -d "$DIR" ]; then
    echo "No powerlevel10k. Setting up powerlevel10k"
    git clone --depth=1 https://github.com/romkatv/powerlevel10k.git "$DIR"
else
    echo "Checking for powerlevel10k: installed"
fi

# Link configuration files
echo "Linking configuration files..."
ln -sf "$DOTFILES/zsh/zshrc" "$HOME/.zshrc"
ln -sf "$DOTFILES/tmux/tmux.conf" "$HOME/.tmux.conf"

# Link Tmuxinator configuration
mkdir -p "$HOME/.config"
if [ -d "$DOTFILES/tmuxinator" ]; then
    ln -sfn "$DOTFILES/tmuxinator" "$HOME/.config/tmuxinator"
fi

# Ensure local bin exists and link custom scripts
mkdir -p "$HOME/.local/bin"
if [ -f "$DOTFILES/scripts/t" ]; then
    ln -sf "$DOTFILES/scripts/t" "$HOME/.local/bin/t"
fi

# Fix for fd in Ubuntu/Debian
if command -v fdfind >/dev/null 2>&1 && ! command -v fd >/dev/null 2>&1; then
    ln -sf "$(which fdfind)" "$HOME/.local/bin/fd"
fi

# Link Neovim configuration
if [ -d "$DOTFILES/nvim" ]; then
    mkdir -p "$HOME/.config"
    ln -sfn "$DOTFILES/nvim" "$HOME/.config/nvim"
fi

# Ensure Intelephense directory and license file exist
mkdir -p "$HOME/intelephense"
if [ ! -f "$HOME/intelephense/license.txt" ]; then
    echo "Creating Intelephense license placeholder..."
    touch "$HOME/intelephense/license.txt"
fi

# Set Zsh as default shell
if [ "$SHELL" != "$(which zsh)" ]; then
    echo "Setting Zsh as the default shell..."
    sudo chsh -s "$(which zsh)" "$USER"
fi

# Opencode installation
if ! command -v opencode >/dev/null 2>&1; then
    echo "Installing Opencode..."
    curl -fsSL https://opencode.ai/install | bash -s -- --no-modify-path
else
    echo "Checking for opencode: installed"
fi

# Opencode Gemini OAuth plugin setup
OPENCODE_CONFIG="$HOME/.config/opencode/opencode.json"
mkdir -p "$(dirname "$OPENCODE_CONFIG")"

if [ ! -f "$OPENCODE_CONFIG" ]; then
    echo "Creating Opencode configuration..."
    cat <<'EOF' > "$OPENCODE_CONFIG"
{
  "$schema": "https://opencode.ai/config.json",
  "plugin": ["opencode-gemini-auth@latest"]
}
EOF
else
    if ! jq -e '.plugin | contains(["opencode-gemini-auth@latest"])' "$OPENCODE_CONFIG" >/dev/null 2>&1; then
        echo "Adding Gemini OAuth plugin to Opencode configuration..."
        jq 'if .plugin then .plugin += ["opencode-gemini-auth@latest"] else .plugin = ["opencode-gemini-auth@latest"] end | .plugin |= unique' "$OPENCODE_CONFIG" > "$OPENCODE_CONFIG.tmp" && mv "$OPENCODE_CONFIG.tmp" "$OPENCODE_CONFIG"
    else
        echo "Checking for Opencode Gemini OAuth plugin: configured"
    fi
fi

# Add auto-transition to Zsh in .bashrc if not already there
if ! grep -q "exec zsh" "$HOME/.bashrc"; then
    echo "Adding auto-transition to Zsh in .bashrc for immediate effect..."
    cat <<'EOF' >> "$HOME/.bashrc"

# Auto-transition to Zsh
if [[ -t 1 ]] && command -v zsh >/dev/null 2>&1; then
    exec zsh
fi
EOF
fi

echo "Installation and linking complete! Please restart your terminal or run 'zsh' to start."
